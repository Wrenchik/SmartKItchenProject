<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ–¥—É–∫—Ç—ã –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–µ</title>
    <style>
        body { font-family: Arial; background: #f4f6f8; padding: 30px; }
        .box { background: white; padding: 20px; border-radius: 10px; max-width: 600px; margin: auto; }
        input, select, button {
            width: 100%; padding: 8px; margin: 6px 0; font-size: 14px;
        }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #43a047; }
        ul { padding-left: 20px; }
    </style>
</head>
<body>
<div style="margin-bottom: 20px;">
    <a href="/" style="
        display: inline-block;
        padding: 8px 14px;
        background: #1976d2;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: bold;
    ">
        üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    </a>

<div class="box">
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</h2>

    <select id="fridges" multiple size="4"></select>
    <select id="product"></select>
    <input id="qty" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
    <input id="unit" placeholder="–ï–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è (–∫–≥ / —à—Ç)">


    <button onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å</button>

    <h3>üì¶ –¢–µ–∫—É—â–∏–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
    <button onclick="loadInventory()">üîÑ –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫—É—Ö–Ω–∏</button>
    <ul id="list"></ul>
</div>

<script>

  let productsMap = {};

async function loadProductsMap() {
    const res = await fetch("/products");
    const data = await res.json();
    productsMap = {};
    data.forEach(p => {
        productsMap[p.id] = p.name;
    });
}
async function loadConsolidated() {
    const ids = selectedFridgeIds();
    if (!ids) return;

    const res = await fetch(`/inventory/consolidated?fridge_ids=${ids}`);
    const data = await res.json();

    list.innerHTML = "";
    data.consolidated.forEach(i => {
        list.innerHTML += `
            <li>
                üì¶ ${i.product} ‚Äî ${i.total_quantity} ${i.unit}
            </li>`;
    });
}

async function loadInventory() {
    const ids = selectedFridgeIds();
    if (!ids) {
        list.innerHTML = "<li>–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫—É—Ö–Ω—é</li>";
        return;
    }

    await loadProductsMap();

    const res = await fetch(`/inventory?fridge_ids=${ids}`);
    const data = await res.json();
    list.innerHTML = "";

    if (data.length === 0) {
        list.innerHTML = "<li>–í –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫—É—Ö–Ω—è—Ö –Ω–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤</li>";
        return;
    }

    data.forEach(i => {
        list.innerHTML += `
        <li>
            üßä –ö—É—Ö–Ω—è ${i.fridge_id} ‚Äî
            üçé ${productsMap[i.product_id]} ‚Äî
            <input type="number" value="${i.quantity}" step="0.1"
                   style="width:60px"
                   onchange="updateItem(${i.id}, this.value)">
            ${i.unit}
            <button onclick="deleteItem(${i.id})">üóë</button>
        </li>`;
    });
}

async function loadFridges() {
    const res = await fetch("/fridges");
    const data = await res.json();
    fridges.innerHTML = "";

    data.forEach(f => {
        fridges.innerHTML += `
            <option value="${f.id}">
                ${f.owner} (id=${f.id})
            </option>`;
    });
}

function selectedFridgeIds() {
    return Array.from(fridges.selectedOptions)
        .map(o => o.value)
        .join(",");
}

async function loadProducts() {
    const res = await fetch("/products");
    const data = await res.json();
    product.innerHTML = "";
    data.forEach(p => {
        product.innerHTML += `<option value="${p.id}">${p.name} (id=${p.id})</option>`;
    });
}


async function addProduct() {
    const fridgeIds = Array.from(fridges.selectedOptions).map(o => o.value);

    if (fridgeIds.length === 0) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫—É—Ö–Ω—é");
        return;
    }
    if (!product.value) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç");
        return;
    }
    if (!qty.value || Number(qty.value) <= 0) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");
        return;
    }
    if (!unit.value.trim()) {
        alert("–í–≤–µ–¥–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è");
        return;
    }

    for (let fid of fridgeIds) {
        const res = await fetch("/inventory", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                fridge_id: Number(fid),
                product_id: Number(product.value),
                quantity: Number(qty.value),
                unit: unit.value.trim()
            })
        });

        if (!res.ok) {
            const err = await res.json();
            alert("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: " + JSON.stringify(err));
            return;
        }
    }

    qty.value = "";
    unit.value = "";
    loadInventory();
}

async function updateItem(id, qty) {
    await fetch(`/inventory/${id}?quantity=${qty}`, {
        method: "PUT"
    });
}

async function deleteItem(id) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –∏–∑ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞?")) return;

    await fetch(`/inventory/${id}`, {
        method: "DELETE"
    });
    loadInventory();
}

loadFridges();
loadProducts();
loadInventory();
</script>


</body>
</html>
