<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–æ—Å—É–¥–∞</title>
    <style>
        body { font-family: Arial; background: #f4f6f8; padding: 30px; }
        .box { background: white; padding: 20px; border-radius: 10px; max-width: 700px; margin: auto; }
        input, select, button {
            width: 100%; padding: 8px; margin: 6px 0; font-size: 14px;
        }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #43a047; }
        ul { padding-left: 20px; }
    </style>
</head>
<body>

<!-- –ö–ù–û–ü–ö–ê –ì–õ–ê–í–ù–û–ì–û –ú–ï–ù–Æ -->
<div style="margin-bottom:20px;">
    <a href="/" style="
        display:inline-block;
        padding:8px 14px;
        background:#1976d2;
        color:white;
        text-decoration:none;
        border-radius:6px;
        font-weight:bold;">
        üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    </a>
</div>

<div class="box">
    <h2>üçΩ –ü–æ—Å—É–¥–∞</h2>

    <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—É–¥—É</h3>

    <select id="fridges" multiple size="4"></select>
    <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (—Å–∫–æ–≤–æ—Ä–æ–¥–∞, –Ω–æ–∂)">
    <input id="qty" type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">

    <button onclick="addEquipment()">–î–æ–±–∞–≤–∏—Ç—å</button>

    <hr>

    <h3>üì¶ –ü–æ—Å—É–¥–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫—É—Ö–Ω—è—Ö</h3>

    <button onclick="loadEquipment()">üîÑ –ü–æ–∫–∞–∑–∞—Ç—å</button>
    <button onclick="loadConsolidated()">üìä –°—É–º–º–∞—Ä–Ω–æ</button>

    <ul id="list"></ul>
</div>

<script>
async function loadFridges() {
    const res = await fetch("/fridges");
    const data = await res.json();
    fridges.innerHTML = "";

    data.forEach((f, index) => {
        fridges.innerHTML += `
            <option value="${f.id}" ${index === 0 ? "selected" : ""}>
                ${f.owner} (id=${f.id})
            </option>`;
    });
}


function selectedFridgeIds() {
    return Array.from(fridges.selectedOptions)
        .map(o => o.value)
        .join(",");
}

async function addEquipment() {
    const ids = Array.from(fridges.selectedOptions).map(o => o.value);

    if (ids.length === 0) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫—É—Ö–Ω—é");
        return;
    }
    if (!name.value.trim()) {
        alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—É–¥—ã");
        return;
    }
    if (!qty.value || Number(qty.value) <= 0) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");
        return;
    }

    for (let id of ids) {
        await fetch("/equipment", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                fridge_id: Number(id),
                name: name.value.trim(),
                quantity: parseInt(qty.value)
            })
        });
    }

    name.value = "";
    qty.value = "";
    loadEquipment();
}

async function loadEquipment() {
    const ids = selectedFridgeIds();
    if (!ids) {
        list.innerHTML = "<li>–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ö–Ω–∏</li>";
        return;
    }

    const res = await fetch(`/equipment?fridge_ids=${ids}`);
    const data = await res.json();
    list.innerHTML = "";

    if (data.length === 0) {
        list.innerHTML = "<li>–ü–æ—Å—É–¥—ã –Ω–µ—Ç</li>";
        return;
    }

    data.forEach(e => {
        list.innerHTML += `
        <li>
            üßä –ö—É—Ö–Ω—è ${e.fridge_id} ‚Äî
            üçΩ ${e.name} ‚Äî
            ${e.quantity} —à—Ç
            <button onclick="deleteEquipment(${e.id})"
                style="margin-left:10px;background:#e53935;color:white;border:none;border-radius:4px;">
                üóë
            </button>
        </li>`;
    });
}

async function loadConsolidated() {
    const ids = selectedFridgeIds();
    if (!ids) return;

    const res = await fetch(`/equipment?fridge_ids=${ids}`);
    const data = await res.json();

    const map = {};
    data.forEach(e => {
        map[e.name] = (map[e.name] || 0) + e.quantity;
    });

    list.innerHTML = "";
    for (let k in map) {
        list.innerHTML += `<li>üì¶ ${k}: ${map[k]} —à—Ç</li>`;
    }
}

async function deleteEquipment(id) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—É–¥—É?")) return;
    await fetch(`/equipment/${id}`, { method: "DELETE" });
    loadEquipment();
}

loadFridges();
</script>

</body>
</html>
